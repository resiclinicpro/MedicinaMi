<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guías Esenciales para Medicina Interna</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
    </style>
</head>
<body class="bg-slate-50">

    <div id="app-container" class="relative min-h-screen lg:flex">
        <!-- Sidebar -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 bg-slate-900 text-slate-300 w-80 p-6 flex flex-col transform -translate-x-full transition-transform duration-300 ease-in-out z-30 shadow-2xl">
            <div class="flex-1 overflow-y-auto min-h-0 pr-2">
                <h2 class="text-2xl font-bold text-center text-sky-400 border-b border-slate-700 pb-4 mb-6">Guías de Medicina Interna</h2>
                <ul id="module-list" class="space-y-2"></ul>
            </div>
            <div class="pt-4 border-t border-slate-700">
                <button id="bibliography-button" class="w-full bg-slate-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition-all hover:bg-slate-600 active:scale-95 mb-2 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 16c1.255 0 2.443-.29 3.5-.804V4.804zM14.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 0114.5 16c1.255 0 2.443-.29 3.5-.804v-10A7.968 7.968 0 0014.5 4z" /></svg>
                    Bibliografía
                </button>
                <button id="reset-button" class="w-full bg-red-600/90 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition-all hover:bg-red-600 active:scale-95 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7V9a1 1 0 01-2 0V3a1 1 0 011-1zm12 1a1 1 0 011 1v3.099A5.002 5.002 0 008.113 14.666 1 1 0 016.228 14A7.002 7.002 0 0115.898 7.534V5a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    Reiniciar Progreso
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main id="main-content" class="flex-1 p-4 sm:p-6 lg:p-8 transition-all duration-300">
            <!-- Home button to return to learning path -->
            <button id="home-button" class="hidden fixed top-4 left-4 bg-white p-2 rounded-full shadow-lg z-40 text-slate-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
            </button>
            
            <!-- Hamburger button for mobile -->
            <button id="menu-toggle" class="hidden lg:hidden fixed top-4 right-4 bg-white p-2 rounded-full shadow-lg z-40 text-slate-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                </svg>
            </button>

            <div id="progress-container" class="w-full bg-slate-200 rounded-full mb-8 shadow-inner">
                <div id="progress-bar" class="bg-sky-500 text-xs font-medium text-white text-center p-1.5 leading-none rounded-full transition-all duration-500" style="width: 0%">0%</div>
            </div>
            <div id="module-display" class="transition-opacity duration-300">
                <!-- El contenido del módulo se insertará aquí -->
            </div>
        </main>
        
        <div id="sidebar-overlay" class="hidden lg:hidden fixed inset-0 bg-black bg-opacity-60 z-20"></div>

    </div>
    
    <!-- Reset Modal -->
    <div id="reset-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-sm w-full text-center transform scale-95 transition-transform duration-300">
            <h3 class="text-xl font-bold text-slate-800">Confirmar Acción</h3>
            <p class="text-slate-600 my-4">¿Estás seguro de que quieres borrar todo tu progreso? Esta acción no se puede deshacer.</p>
            <div class="flex justify-center gap-4 mt-6">
                <button id="cancel-reset" class="py-2 px-6 bg-slate-200 text-slate-800 font-semibold rounded-lg hover:bg-slate-300 transition-colors">Cancelar</button>
                <button id="confirm-reset" class="py-2 px-6 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition-colors">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Bibliography Modal -->
    <div id="bibliography-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-3xl w-full text-left transform scale-95 transition-transform duration-300 relative">
            <button id="close-bibliography-modal" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h3 class="text-2xl font-bold text-slate-800 flex items-center gap-2 border-b pb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-sky-500" viewBox="0 0 20 20" fill="currentColor"><path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 16c1.255 0 2.443-.29 3.5-.804V4.804zM14.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 0114.5 16c1.255 0 2.443-.29 3.5-.804v-10A7.968 7.968 0 0014.5 4z" /></svg>
                Fuentes Bibliográficas
            </h3>
            <div id="bibliography-content" class="text-slate-600 my-4 space-y-3 max-h-[70vh] overflow-y-auto pr-4">
                <!-- Bibliography will be injected here -->
            </div>
        </div>
    </div>

    <!-- Summary Modal -->
    <div id="summary-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-4xl w-full text-left transform scale-95 transition-transform duration-300 relative">
            <button id="close-summary-modal" class="absolute top-4 right-4 text-slate-500 hover:text-slate-800 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h3 class="text-2xl font-bold text-slate-800 flex items-center gap-3 border-b pb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-sky-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>
                Síntesis Clave para el Internista
            </h3>
            <div id="summary-content" class="text-slate-700 my-4 space-y-4 max-h-[70vh] overflow-y-auto pr-4">
                <!-- Summary will be injected here -->
            </div>
        </div>
    </div>


        <script>
        const summaryContentHtml = `
            <div class="space-y-6">
                <div>
                    <h4 class="text-lg font-bold text-slate-800">1. Hipertensión Arterial (AHA/ACC 2025): Precisión y Proactividad</h4>
                    <p>El manejo moderno de la HTA exige ir más allá de la cifra del consultorio. La confirmación con <strong>Monitoreo Ambulatorio de Presión Arterial (MAPA) o Domiciliario (MDPA)</strong> es crucial. El inicio del tratamiento se basa en el <strong>riesgo cardiovascular a 10 años (calculadora PREVENT™)</strong>, no solo en la cifra de PA (iniciar fármacos en HTA grado 1 si riesgo ≥7.5%). La <strong>terapia combinada en un solo comprimido (SPC)</strong> es la estrategia de elección para mejorar la adherencia y alcanzar metas más rápido, especialmente en HTA grado 2. En HTA resistente, la <strong>espironolactona</strong> es el cuarto fármaco preferente tras optimizar diuréticos.</p>
                </div>
                <div>
                    <h4 class="text-lg font-bold text-slate-800">2. Dislipidemias (ESC/EAS 2025): "Cuanto más bajo, mejor" y estratificado</h4>
                    <p>La piedra angular es la nueva estratificación del riesgo con <strong>SCORE2/SCORE2-OP</strong> para definir metas de <strong>C-LDL extremadamente rigurosas</strong> (ej. <55 mg/dL en muy alto riesgo y <40 mg/dL en riesgo extremo). Las <strong>estatinas de alta intensidad</strong> son la primera línea. Si no se alcanzan metas, la adición secuencial de <strong>ezetimiba</strong> y luego <strong>iPCSK9</strong> es el estándar. El <strong>ácido bempedoico</strong> es una nueva opción clave para intolerantes a estatinas. Para hipertrigliceridemia con alto riesgo CV residual, se recomienda <strong>icosapent etilo</strong>. Se debe medir <strong>Lipoproteína(a)</strong> al menos una vez en la vida, considerándola un modificador de riesgo si >50 mg/dL.</p>
                </div>
                <div>
                    <h4 class="text-lg font-bold text-slate-800">3. Insuficiencia Cardíaca (ESC 2023 / AHA/ACC/HFSA 2022): Los Pilares Fundamentales</h4>
                    <p>En la Insuficiencia Cardíaca con Fracción de Eyección Reducida (ICFEr), el tratamiento se basa en la instauración rápida y simultánea de los <strong>"cuatro pilares"</strong>: <strong>1)</strong> ARNI/IECA/ARA2, <strong>2)</strong> Betabloqueante, <strong>3)</strong> Antagonista del Receptor de Mineralocorticoides (ARM), y <strong>4)</strong> Inhibidor de SGLT2 (iSGLT2). Este enfoque reduce drásticamente la mortalidad. En la IC con Fracción de Eyección Preservada (ICFEp) y Levemente Reducida (ICFElr), los <strong>iSGLT2</strong> y los <strong>ARM</strong> son ahora terapias fundamentales con evidencia de beneficio (Clase I).</p>
                </div>
                <div>
                    <h4 class="text-lg font-bold text-slate-800">4. Fibrilación Auricular (ACC/AHA/ACCP/HRS 2023): El Enfoque Integral "ABCDE"</h4>
                    <p>El manejo de la FA se estructura en el pathway <strong>"A-B-C-D-E"</strong>: <strong>A</strong> (Anticoagulation): Estratificar con <strong>CHA₂DS₂-VASc</strong> y preferir <strong>Anticoagulantes Orales Directos (ACOD)</strong>. <strong>B</strong> (Better symptom control): Control de frecuencia o ritmo, considerando la <strong>ablación por catéter como terapia de primera línea</strong> en pacientes seleccionados. <strong>C</strong> (Cardiovascular risk): Manejo de comorbilidades. Las nuevas guías añaden: <strong>D</strong> (Risk factor management) y <strong>E</strong> (Lifestyle and patient Education), enfatizando el manejo agresivo de factores como obesidad y alcohol, y la educación del paciente como parte integral del tratamiento.</p>
                </div>
            </div>
        `;
        
        const courseModules = [
            {
                id: 1,
                displayNumber: 1,
                title: "Módulo 1: Hipertensión Arterial (AHA/ACC 2025)",
                summary: `Este módulo se enfoca en el diagnóstico preciso y el manejo inicial estratificado de la HTA, basándose en la guía de la ACC/AHA de 2025. Aprenderás a valorar la importancia del monitoreo fuera del consultorio (MAPA/MDPA), a calcular el riesgo cardiovascular para guiar las decisiones terapéuticas y a seleccionar la terapia farmacológica inicial más apropiada, priorizando las combinaciones en un solo comprimido para maximizar la adherencia y la eficacia.`,
                clinicalCase: `Un hombre de 58 años, con diabetes tipo 2 e índice de masa corporal de 31 kg/m², acude a su consulta. Su MDPA de 7 días revela un promedio de 145/88 mmHg. Su riesgo cardiovascular a 10 años (PREVENT) se calcula en 22%. Actualmente, solo toma metformina. Sus electrolitos y función renal son normales.<br><br><strong>Pregunta clave:</strong> Basado en la guía ACC/AHA de 2025, ¿cuál es la estrategia de manejo inicial más efectiva y basada en evidencia para este paciente, y cuál es el error conceptual más común que se debe evitar?`,
                clinicalCaseAnswer: `La estrategia de manejo inicial más apropiada es iniciar <strong>terapia combinada dual con un solo comprimido (SPC)</strong>, idealmente un IECA/ARA2 más un calcioantagonista dihidropiridínico (ej. amlodipino). Dado que su PA es >20/10 mmHg por encima del objetivo (<130/80 mmHg) y tiene un riesgo PREVENT >7.5%, la monoterapia es insuficiente. El error conceptual más común es iniciar monoterapia y ajustar la dosis lentamente. La guía de 2025 enfatiza el inicio temprano con terapia combinada para un control rápido y sostenido.`,
                quiz: [
                    {
                        question: `Una mujer de 62 años con HTA y Enfermedad Renal Crónica (TFG 40 ml/min/1.73m² y albuminuria de 50 mg/g) está en tratamiento con losartán 100 mg/día. Su PA promedio en MDPA es 138/84 mmHg. Según la guía ACC/AHA de 2025, ¿cuál es el siguiente paso más apropiado para intensificar su tratamiento?`,
                        options: [
                            "Agregar amlodipino 5 mg.",
                            "Agregar hidroclorotiazida 25 mg.",
                            "Agregar espironolactona 12.5 mg.",
                            "Agregar bisoprolol 5 mg."
                        ],
                        answer: 0,
                        justification: `La guía de 2025 recomienda el uso de un IECA o ARA2 en pacientes con HTA y ERC con albuminuria. Al no estar en metas de PA, la adición de un calcioantagonista (amlodipino) es una combinación de primera línea preferente y eficaz. Las tiazidas son menos potentes con TFG <45 ml/min, y la espironolactona se reserva para HTA resistente.`,
                        source: `Jones DW, Ferdinand KC, Taler SJ, Johnson HM, Shimbo D, Abdalla M, et al. 2025 AHA/ACC/AANP/AAPA/ABC/ACCP/ACPM/AGS/AMA/ASPC/NMA/PCNA/SGIM Guideline for the Prevention, Detection, Evaluation and Management of High Blood Pressure in Adults: A Report of the American College of Cardiology/American Heart Association Joint Committee on Clinical Practice Guidelines. Hypertension. 2025;82:e212-e316. doi: 10.1161/HYP.0000000000000249`
                    },
                    {
                        question: `Un paciente de 70 años, con historial de un ACV isquémico hace un año, tiene una PA en consulta de 145/85 mmHg. ¿Cuál es el umbral de PA para iniciar tratamiento y el objetivo terapéutico según la guía ACC/AHA de 2025 para prevención secundaria de enfermedad cerebrovascular?`,
                        options: [
                            "Iniciar si PA ≥140/90 mmHg, con objetivo <140/90 mmHg.",
                            "Iniciar si PA ≥140/90 mmHg, con objetivo <130/80 mmHg.",
                            "Iniciar si PA ≥130/80 mmHg, con objetivo <130/80 mmHg.",
                            "Iniciar solo si es sintomático, con objetivo <140/90 mmHg."
                        ],
                        answer: 2,
                        justification: `La guía de 2025 (Sección 5.3.9.3) establece que para pacientes con enfermedad cardiovascular clínica (como un ACV previo), el tratamiento debe iniciarse si la PA es ≥130/80 mmHg, con un objetivo de PA <130/80 mmHg para reducir el riesgo de recurrencia.`,
                        source: `Jones DW, Ferdinand KC, Taler SJ, Johnson HM, Shimbo D, Abdalla M, et al. 2025 AHA/ACC/AANP/AAPA/ABC/ACCP/ACPM/AGS/AMA/ASPC/NMA/PCNA/SGIM Guideline for the Prevention, Detection, Evaluation and Management of High Blood Pressure in Adults: A Report of the American College of Cardiology/American Heart Association Joint Committee on Clinical Practice Guidelines. Hypertension. 2025;82:e212-e316. doi: 10.1161/HYP.0000000000000249`
                    },
                    {
                        question: `Un paciente está en tratamiento con lisinopril, amlodipino y clortalidona a dosis máximas. Su PA en MAPA de 24h es de 142/91 mmHg. Se confirma HTA resistente. Según la guía ACC/AHA de 2025, ¿cuál de las siguientes intervenciones se recomienda como siguiente paso farmacológico preferente?`,
                        options: [
                            "Añadir un betabloqueante como bisoprolol.",
                            "Añadir un alfabloqueante como doxazosina.",
                            "Añadir un antagonista del receptor de mineralocorticoides como espironolactona.",
                            "Añadir un agente de acción central como clonidina."
                        ],
                        answer: 2,
                        justification: `La guía de 2025 (Sección 5.6) recomienda que para la HTA resistente, tras optimizar la terapia diurética, se añada un antagonista del receptor de mineralocorticoides (ARM) como la espironolactona, basándose en la sólida evidencia de su superioridad como cuarto fármaco.`,
                        source: `Jones DW, Ferdinand KC, Taler SJ, Johnson HM, Shimbo D, Abdalla M, et al. 2025 AHA/ACC/AANP/AAPA/ABC/ACCP/ACPM/AGS/AMA/ASPC/NMA/PCNA/SGIM Guideline for the Prevention, Detection, Evaluation and Management of High Blood Pressure in Adults: A Report of the American College of Cardiology/American Heart Association Joint Committee on Clinical Practice Guidelines. Hypertension. 2025;82:e212-e316. doi: 10.1161/HYP.0000000000000249`
                    },
                    {
                        question: `Una mujer de 45 años, sin comorbilidades, presenta consistentemente PA en consulta de 135/85 mmHg. Se realiza un MAPA de 24h que muestra una PA diurna promedio de 148/94 mmHg. ¿Cuál es la interpretación y manejo correctos según la guía ACC/AHA de 2025?`,
                        options: [
                            "Es HTA de bata blanca; no requiere tratamiento.",
                            "Es HTA enmascarada; requiere iniciar tratamiento farmacológico y cambios de estilo de vida.",
                            "Es HTA grado 1, se deben iniciar cambios en el estilo de vida exclusivamente.",
                            "Es una respuesta normal al estrés, no se considera hipertensión."
                        ],
                        answer: 1,
                        justification: `La guía de 2025 (Sección 3.2.2) refuerza la importancia de diagnosticar la HTA enmascarada (PA normal en consulta pero elevada fuera de ella) mediante monitoreo ambulatorio. Este patrón se asocia con un mayor riesgo cardiovascular, por lo que se recomienda tratar a estos pacientes con cambios de estilo de vida y tratamiento farmacológico.`,
                        source: `Jones DW, Ferdinand KC, Taler SJ, Johnson HM, Shimbo D, Abdalla M, et al. 2025 AHA/ACC/AANP/AAPA/ABC/ACCP/ACPM/AGS/AMA/ASPC/NMA/PCNA/SGIM Guideline for the Prevention, Detection, Evaluation and Management of High Blood Pressure in Adults: A Report of the American College of Cardiology/American Heart Association Joint Committee on Clinical Practice Guidelines. Hypertension. 2025;82:e212-e316. doi: 10.1161/HYP.0000000000000249`
                    },
                    {
                        question: `(Metacognitiva) Un paciente tiene una PA de 138/88 mmHg y un riesgo a 10 años (PREVENT) del 6%. Sientes la tentación de iniciar fármacos. Según la guía ACC/AHA de 2025, ¿qué principio clave aplicas al decidir no iniciar fármacos y solo recomendar cambios de estilo de vida por 3-6 meses?`,
                        options: [
                            "Evitar la inercia terapéutica.",
                            "Aplicar el umbral de riesgo para iniciar tratamiento farmacológico en HTA grado 1.",
                            "Priorizar siempre la farmacoterapia sobre el estilo de vida.",
                            "Tratar todas las cifras de HTA grado 1 con fármacos."
                        ],
                        answer: 1,
                        justification: `La guía de 2025 (Sección 5.2.2) recomienda iniciar tratamiento farmacológico en HTA grado 1 (130-139 / 80-89 mmHg) si el riesgo PREVENT a 10 años es ≥7.5%. Para este paciente, con un riesgo del 6%, la decisión correcta es enfocarse en cambios intensivos del estilo de vida y reevaluar en 3-6 meses, evitando la medicalización innecesaria.`,
                        source: `Jones DW, Ferdinand KC, Taler SJ, Johnson HM, Shimbo D, Abdalla M, et al. 2025 AHA/ACC/AANP/AAPA/ABC/ACCP/ACPM/AGS/AMA/ASPC/NMA/PCNA/SGIM Guideline for the Prevention, Detection, Evaluation and Management of High Blood Pressure in Adults: A Report of the American College of Cardiology/American Heart Association Joint Committee on Clinical Practice Guidelines. Hypertension. 2025;82:e212-e316. doi: 10.1161/HYP.0000000000000249`
                    }
                ]
            },
            {
                id: 2,
                displayNumber: 2,
                title: "Módulo 2: Dislipidemias (ESC/EAS 2025 Focused Update)",
                summary: `Este módulo se centra en las últimas actualizaciones de la guía ESC/EAS de 2025. Se aborda la nueva estratificación de riesgo con SCORE2/SCORE2-OP, el manejo agresivo del C-LDL post-SCA, el rol de nuevas terapias como el ácido bempedoico y la importancia clínica de la Lipoproteína(a) y el icosapent etilo.`,
                clinicalCase: `Un hombre de 66 años con antecedentes de infarto de miocardio hace 2 años, está en tratamiento con atorvastatina 80 mg/día. Su C-LDL es de 75 mg/dL. Refiere mialgias leves intermitentes, con CK normal.<br><br><strong>Pregunta clave:</strong> Considerando que es un paciente en prevención secundaria (muy alto riesgo CV), ¿cuál es el siguiente paso terapéutico según la guía ESC/EAS 2025?`,
                clinicalCaseAnswer: `El paciente no ha alcanzado la meta de C-LDL de la guía 2025 para muy alto riesgo (<55 mg/dL y reducción del 50%). El siguiente paso recomendado es <strong>añadir ezetimiba 10 mg/día</strong>. Si con esta combinación aún no se alcanza la meta, se debe considerar añadir un inhibidor de PCSK9. Para pacientes con intolerancia a estatinas documentada, el ácido bempedoico es una nueva opción recomendada.`,
                quiz: [
                    {
                        question: `Una mujer de 55 años, diabética tipo 2 de 12 años de evolución sin daño a órgano diana, con un C-LDL de 165 mg/dL. Según la guía ESC/EAS 2025, ¿en qué categoría de riesgo se clasifica y cuál es su objetivo de C-LDL?`,
                        options: [
                            "Riesgo alto; objetivo C-LDL <70 mg/dL.",
                            "Riesgo muy alto; objetivo C-LDL <55 mg/dL.",
                            "Riesgo moderado; objetivo C-LDL <100 mg/dL.",
                            "Riesgo alto; objetivo C-LDL <100 mg/dL."
                        ],
                        answer: 0,
                        justification: `La guía ESC/EAS 2025 (Tabla 3) clasifica a los pacientes con diabetes mellitus >10 años de duración en la categoría de 'alto riesgo'. Para esta categoría, el objetivo es un C-LDL <1.8 mmol/L (<70 mg/dL) y una reducción de al menos el 50% del basal.`,
                        source: `Mach F, Koskinas KC, Roeters van Lennep JE, Tokgözoğlu L, Badimon L, Baigent C, et al. 2025 Focused Update of the 2019 ESC/EAS Guidelines for the management of dyslipidaemias. Eur Heart J. 2025;00:1-20. doi: 10.1093/eurheartj/ehaf190`
                    },
                    {
                        question: `Un paciente en prevención secundaria está con rosuvastatina 40 mg y ezetimiba 10 mg. Su C-LDL persiste en 65 mg/dL. Según la guía ESC/EAS 2025, ¿cuál es el siguiente paso más potente para alcanzar la meta de C-LDL <55 mg/dL?`,
                        options: [
                            "Añadir ácido bempedoico.",
                            "Añadir un fibrato.",
                            "Añadir un inhibidor de PCSK9 o inclisiran.",
                            "Mantener el tratamiento actual, ya que está cerca del objetivo."
                        ],
                        answer: 2,
                        justification: `Para un paciente de muy alto riesgo que no alcanza la meta de C-LDL <55 mg/dL a pesar del tratamiento oral máximo, las guías recomiendan añadir un inhibidor de PCSK9 o inclisiran, que ofrecen una potente reducción adicional del C-LDL (≈50-60%). El ácido bempedoico es una opción, pero menos potente (≈18% de reducción adicional).`,
                        source: `Mach F, Koskinas KC, Roeters van Lennep JE, Tokgözoğlu L, Badimon L, Baigent C, et al. 2025 Focused Update of the 2019 ESC/EAS Guidelines for the management of dyslipidaemias. Eur Heart J. 2025;00:1-20. doi: 10.1093/eurheartj/ehaf190`
                    },
                    {
                        question: `Un paciente de alto riesgo CV con C-LDL controlado con estatinas presenta triglicéridos persistentes de 250 mg/dL. Según la guía ESC/EAS 2025, ¿cuál es la terapia adicional recomendada para reducir el riesgo de eventos cardiovasculares?`,
                        options: [
                            "Añadir fenofibrato.",
                            "Añadir icosapent etilo (2x2 g/día).",
                            "Añadir una combinación de EPA/DHA.",
                            "No añadir ningún otro fármaco."
                        ],
                        answer: 1,
                        justification: `La guía 2025 (Recomendación Tabla 5), basándose en el estudio REDUCE-IT y contrastando con el STRENGTH (EPA/DHA), recomienda específicamente icosapent etilo a altas dosis (2x2 g/día) para reducir el riesgo CV residual en pacientes de alto riesgo con hipertrigliceridemia a pesar del tratamiento con estatinas.`,
                        source: `Mach F, Koskinas KC, Roeters van Lennep JE, Tokgözoğlu L, Badimon L, Baigent C, et al. 2025 Focused Update of the 2019 ESC/EAS Guidelines for the management of dyslipidaemias. Eur Heart J. 2025;00:1-20. doi: 10.1093/eurheartj/ehaf190`
                    },
                    {
                        question: `Según la actualización de 2025 de la guía ESC/EAS, ¿qué afirmación sobre la Lipoproteína(a) [Lp(a)] es correcta?`,
                        options: [
                            "Debe medirse anualmente en todos los pacientes.",
                            "Niveles >50 mg/dL deben considerarse un factor que aumenta el riesgo cardiovascular.",
                            "El tratamiento con estatinas es la terapia de primera línea para reducir la Lp(a).",
                            "Solo debe medirse en pacientes con hipercolesterolemia familiar."
                        ],
                        answer: 1,
                        justification: `La guía 2025 (Recomendación Tabla 4) establece una nueva recomendación (Clase IIa, Nivel B) de que niveles de Lp(a) >50 mg/dL deben ser considerados un factor que aumenta el riesgo CV. También reitera que se debe considerar su medición al menos una vez en la vida de cada adulto.`,
                        source: `Mach F, Koskinas KC, Roeters van Lennep JE, Tokgözoğlu L, Badimon L, Baigent C, et al. 2025 Focused Update of the 2019 ESC/EAS Guidelines for the management of dyslipidaemias. Eur Heart J. 2025;00:1-20. doi: 10.1093/eurheartj/ehaf190`
                    },
                    {
                        question: `Un paciente con intolerancia documentada a las estatinas (mialgias con al menos dos estatinas diferentes) tiene un C-LDL de 140 mg/dL y un riesgo CV alto. ¿Qué nueva terapia oral es recomendada por la guía ESC/EAS 2025 para este escenario?`,
                        options: [
                            "Fibratos.",
                            "Ácido bempedoico.",
                            "Suplementos de arroz de levadura roja.",
                            "Solo ezetimiba."
                        ],
                        answer: 1,
                        justification: `La guía 2025 (Recomendación Tabla 2), basándose en el estudio CLEAR Outcomes, recomienda el ácido bempedoico (Clase I, Nivel B) en pacientes que no pueden tomar estatinas para alcanzar el objetivo de C-LDL. Su mecanismo de acción no afecta al músculo esquelético.`,
                        source: `Mach F, Koskinas KC, Roeters van Lennep JE, Tokgözoğlu L, Badimon L, Baigent C, et al. 2025 Focused Update of the 2019 ESC/EAS Guidelines for the management of dyslipidaemias. Eur Heart J. 2025;00:1-20. doi: 10.1093/eurheartj/ehaf190`
                    }
                ]
            }
        ];

        let userProgress = {};
        let currentModuleId = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadProgress();
            renderModuleList();
            renderBibliography();
            renderSummary();
            
            let lastModuleId = null;
            try {
                lastModuleId = localStorage.getItem('internaLastModuleId');
            } catch (e) {
                console.error("Error fetching last module:", e);
            }
            displayModule(lastModuleId ? parseInt(lastModuleId) : null);

            setupEventListeners();
        });

        function setupEventListeners() {
            const resetButton = document.getElementById('reset-button');
            const resetModal = document.getElementById('reset-modal');
            const cancelReset = document.getElementById('cancel-reset');
            const confirmReset = document.getElementById('confirm-reset');
            const menuToggle = document.getElementById('menu-toggle');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const bibliographyButton = document.getElementById('bibliography-button');
            const bibliographyModal = document.getElementById('bibliography-modal');
            const closeBibliographyModal = document.getElementById('close-bibliography-modal');
            const homeButton = document.getElementById('home-button');
            
            const summaryButton = document.getElementById('summary-button');
            const summaryModal = document.getElementById('summary-modal');
            const closeSummaryModal = document.getElementById('close-summary-modal');

            resetButton.addEventListener('click', () => {
                resetModal.classList.remove('hidden');
                setTimeout(() => {
                    resetModal.querySelector('div').classList.remove('scale-95');
                }, 10);
            });
            cancelReset.addEventListener('click', () => {
                resetModal.querySelector('div').classList.add('scale-95');
                setTimeout(() => resetModal.classList.add('hidden'), 300);
            });
            confirmReset.addEventListener('click', resetProgress);
            
            menuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('-translate-x-full');
                sidebarOverlay.classList.toggle('hidden');
            });
            sidebarOverlay.addEventListener('click', () => {
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.add('hidden');
            });

            bibliographyButton.addEventListener('click', showBibliographyModal);
            closeBibliographyModal.addEventListener('click', hideBibliographyModal);
            bibliographyModal.addEventListener('click', (event) => {
                if (event.target === bibliographyModal) {
                    hideBibliographyModal();
                }
            });

            if(summaryButton) {
                summaryButton.addEventListener('click', showSummaryModal);
            }
            closeSummaryModal.addEventListener('click', hideSummaryModal);
            summaryModal.addEventListener('click', (event) => {
                if (event.target === summaryModal) {
                    hideSummaryModal();
                }
            });

            homeButton.addEventListener('click', () => displayModule(null));
        }
        
        function initializeProgress() {
            userProgress = {};
            const totalModules = 17; // Total number of guides in the curriculum
            for (let i = 1; i <= totalModules; i++) {
                userProgress[i] = { completed: false, score: 0, answers: {} };
            }
        }
        
        function loadProgress() {
            try {
                const savedProgress = localStorage.getItem('internaCourseProgress');
                if (savedProgress) {
                    userProgress = JSON.parse(savedProgress);
                    const totalModulesInCourse = 17; 
                    if (Object.keys(userProgress).length !== totalModulesInCourse) {
                        initializeProgress();
                    }
                } else {
                    initializeProgress();
                }
            } catch (e) {
                console.error("Error loading progress:", e);
                initializeProgress();
            }
            saveProgress();
            updateProgressBar();
        }


        function saveProgress() {
            try {
                localStorage.setItem('internaCourseProgress', JSON.stringify(userProgress));
                if (currentModuleId) {
                    localStorage.setItem('internaLastModuleId', currentModuleId);
                } else {
                    localStorage.removeItem('internaLastModuleId');
                }
            } catch (e) {
                console.error("Error saving progress:", e);
            }
        }
        
        function resetProgress() {
            try {
                localStorage.removeItem('internaCourseProgress');
                localStorage.removeItem('internaLastModuleId');
            } catch (e) {
                console.error("Error resetting progress:", e);
            }
            window.location.reload();
        }

        function renderModuleList() {
            const list = document.getElementById('module-list');
            list.innerHTML = '';
            const totalModulesInCourse = 17; 

            for (let i = 1; i <= totalModulesInCourse; i++) {
                const module = courseModules.find(m => m.id === i);
                const li = document.createElement('li');
                const isCompleted = userProgress[i] && userProgress[i].completed;
                const isActive = i === currentModuleId;
                const isDefined = !!module; 

                const baseClasses = 'p-3 rounded-lg cursor-pointer transition-all duration-200 flex items-center gap-3';
                let stateClasses;
                let iconHtml;
                let titleText;

                if (!isDefined) {
                    stateClasses = 'bg-slate-800 text-slate-500 cursor-not-allowed';
                    iconHtml = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 opacity-50 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>`;
                    titleText = `Módulo ${i}: Próximamente`;
                } else {
                    titleText = module.title;
                    stateClasses = 'bg-slate-700 hover:bg-slate-600 hover:pl-4';
                    iconHtml = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 opacity-70 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 16c1.255 0 2.443-.29 3.5-.804V4.804zM14.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 0114.5 16c1.255 0 2.443-.29 3.5-.804v-10A7.968 7.968 0 0014.5 4z" /></svg>`;
                }
                
                if (isDefined && isCompleted) {
                    stateClasses = 'bg-emerald-800/80 hover:bg-emerald-700/80 text-emerald-300';
                    iconHtml = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-emerald-400 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`;
                }
                if (isDefined && isActive) {
                    stateClasses = 'bg-sky-600 font-bold text-white shadow-lg';
                }
                
                li.className = `${baseClasses} ${stateClasses}`;
                li.innerHTML = `${iconHtml} <span>${titleText}</span>`;
                
                if (isDefined) {
                    li.dataset.moduleId = i;
                    li.onclick = () => {
                        displayModule(i);
                        if (window.innerWidth < 1024) {
                            document.getElementById('sidebar').classList.add('-translate-x-full');
                            document.getElementById('sidebar-overlay').classList.add('hidden');
                        }
                    };
                }
                list.appendChild(li);
            }
        }
        
        function displayWelcomeScreen() {
            const displayArea = document.getElementById('module-display');
            const totalModules = 17;
            
            const moduleTitles = [
                "Hipertensión Arterial", "Dislipidemias", "Insuficiencia Cardíaca", "Fibrilación Auricular", "Diabetes Mellitus", 
                "Cáncer de Tiroides", "Hipertiroidismo", "Hipotiroidismo", "EPOC", "Neumonía Comunitaria", "Enfermedad Renal Crónica",
                "ITU Complicada", "Tromboembolia Venosa", "ERGE", "Cirrosis", "Gota", "Vacunación Adultos"
            ];

            const firstUncompletedId = Object.keys(userProgress).map(Number).find(id => !userProgress[id].completed && courseModules.find(m => m.id === id));
            const firstUncompletedModule = courseModules.find(m => m.id === firstUncompletedId);

            let nextUpHtml = '';
            if (firstUncompletedModule) {
                nextUpHtml = `
                    <div class="mb-12">
                        <h2 class="text-2xl font-bold text-slate-800 mb-4">Continuar Aprendizaje</h2>
                        <div class="bg-gradient-to-br from-purple-500 to-fuchsia-600 rounded-2xl p-6 text-white shadow-2xl shadow-purple-200 flex flex-col md:flex-row items-center gap-6">
                            <div class="flex-shrink-0">
                                <div class="w-20 h-20 bg-white/20 rounded-full flex items-center justify-center animate-pulse">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v11.494m-5.747-4.247l11.494 0M4.253 12l15.494 0" />
                                    </svg>
                                </div>
                            </div>
                            <div class="flex-1 text-center md:text-left">
                                <span class="text-sm font-bold uppercase tracking-wider bg-white/20 px-3 py-1 rounded-full">Siguiente Módulo</span>
                                <h3 class="text-2xl font-bold mt-3">${firstUncompletedModule.title}</h3>
                                <p class="mt-2 opacity-80 max-w-2xl">${firstUncompletedModule.summary.substring(0, 150)}...</p>
                            </div>
                            <button onclick="displayModule(${firstUncompletedModule.id})" class="mt-4 md:mt-0 w-full md:w-auto bg-white text-purple-600 font-bold py-3 px-6 rounded-lg shadow-lg transition-transform hover:scale-105 active:scale-100 flex-shrink-0">
                                Comenzar Módulo
                            </button>
                        </div>
                    </div>
                `;
            }

            let allModulesHtml = '<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5">';
            for (let i = 1; i <= totalModules; i++) {
                const module = courseModules.find(m => m.id === i);
                const isCompleted = userProgress[i]?.completed;
                const title = module ? module.title.split(': ')[1] : moduleTitles[i-1];

                let cardHtml;
                if (module) {
                    const statusClass = isCompleted ? 'border-l-emerald-500' : 'border-l-slate-300';
                    const icon = isCompleted 
                        ? `<div class="text-emerald-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg></div>`
                        : `<div class="text-slate-400"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg></div>`;
                    
                    cardHtml = `
                        <div class="bg-white p-5 rounded-lg shadow-sm border-l-4 ${statusClass} flex items-center gap-4 cursor-pointer transition-all hover:shadow-lg hover:border-l-purple-500 hover:scale-[1.02]" onclick="displayModule(${i})">
                            <div class="flex-1">
                                <p class="text-xs font-bold text-slate-500">Módulo ${i}</p>
                                <h4 class="font-semibold text-slate-800 mt-1">${title}</h4>
                            </div>
                            ${icon}
                        </div>
                    `;
                } else {
                    cardHtml = `
                        <div class="bg-slate-100 p-5 rounded-lg border-l-4 border-slate-300 flex items-center gap-4 cursor-not-allowed opacity-70">
                             <div class="flex-1">
                                <p class="text-xs font-bold text-slate-500">Módulo ${i}</p>
                                <h4 class="font-semibold text-slate-500 mt-1">${title}</h4>
                            </div>
                            <div class="text-slate-400"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" /></svg></div>
                        </div>
                    `;
                }
                allModulesHtml += cardHtml;
            }
            allModulesHtml += '</div>';

            displayArea.innerHTML = `
                <div>
                    <div class="bg-gradient-to-br from-purple-50 to-fuchsia-100 p-8 rounded-2xl shadow-inner border border-slate-200/50 text-center mb-12">
                        <h1 class="text-3xl md:text-4xl font-extrabold text-slate-800 tracking-tight">Guías de Estudio Interactivas</h1>
                        <p class="mt-3 text-lg text-slate-600 max-w-3xl mx-auto">Una ruta de aprendizaje basada en las guías clínicas más recientes. Tu progreso se guarda en este dispositivo.</p>
                    </div>
                    
                    ${nextUpHtml}

                    <div>
                        <h2 class="text-2xl font-bold text-slate-800 mb-4 mt-6">Ruta de Aprendizaje Completa</h2>
                        ${allModulesHtml}
                    </div>

                    <div class="mt-12 border-t pt-8">
                        <div class="bg-white p-6 rounded-xl shadow-md border flex flex-col sm:flex-row items-center justify-between gap-4">
                            <div>
                                <h4 class="font-bold text-slate-800 text-lg">¿Buscas un Repaso Rápido?</h4>
                                <p class="text-slate-600">Consulta los conceptos clave de todas las guías en un solo lugar.</p>
                            </div>
                            <button onclick="showSummaryModal()" class="bg-purple-600 text-white font-semibold py-2 px-6 rounded-lg shadow-sm hover:bg-purple-700 transition-all active:scale-95 flex-shrink-0">
                                Ver Síntesis Clave
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }


        function displayModule(moduleId) {
            const homeButton = document.getElementById('home-button');
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content');
            const menuToggle = document.getElementById('menu-toggle');

            if (!document.getElementById('main-content')) return;
            document.getElementById('main-content').scrollTop = 0;
            
            const displayArea = document.getElementById('module-display');
            if (!displayArea) return;
            displayArea.classList.add('opacity-0');

            setTimeout(() => {
                currentModuleId = moduleId ? parseInt(moduleId) : null;
                saveProgress();

                if (!currentModuleId) {
                    // Welcome screen state
                    homeButton.classList.add('hidden');
                    menuToggle.classList.add('hidden');
                    sidebar.classList.remove('lg:translate-x-0');
                    mainContent.classList.remove('lg:ml-80');
                    homeButton.classList.remove('lg:left-[21rem]');

                    displayWelcomeScreen();
                    renderModuleList(); 
                    displayArea.classList.remove('opacity-0');
                    return;
                }
            
                // Module view state
                homeButton.classList.remove('hidden');
                menuToggle.classList.remove('hidden');
                sidebar.classList.add('lg:translate-x-0');
                mainContent.classList.add('lg:ml-80');
                homeButton.classList.add('lg:left-[21rem]');
                
                const moduleData = courseModules.find(m => m.id === currentModuleId);
                
                if (!moduleData) {
                    console.error("Module not found:", currentModuleId);
                    displayModule(null); // Go back to welcome screen
                    displayArea.classList.remove('opacity-0');
                    return;
                }
                
                if (userProgress[currentModuleId] && userProgress[currentModuleId].completed) {
                    showCompletedModule(currentModuleId);
                } else {
                    showActiveModule(currentModuleId);
                }

                renderModuleList();
                displayArea.classList.remove('opacity-0');
            }, 200);
        }

        function showActiveModule(moduleId) {
            const moduleData = courseModules.find(m => m.id === moduleId);
            const displayArea = document.getElementById('module-display');

            let quizHtml = `<form class="quiz-form space-y-6 mt-8" id="quiz-form-${moduleId}">`;
            moduleData.quiz.forEach((q, index) => {
                quizHtml += `<div class="question-block bg-white p-6 rounded-xl shadow-lg border border-slate-100" id="q-block-${moduleId}-${index}">
                                        <p class="font-semibold text-slate-800 mb-4 text-base sm:text-lg">${index + 1}. ${q.question}</p>
                                        <div class="space-y-3">`;
                q.options.forEach((opt, optIndex) => {
                    quizHtml += `<label class="flex items-center p-4 border-2 border-slate-200 rounded-lg cursor-pointer transition-all duration-200 hover:bg-sky-50 hover:border-sky-400 has-[:checked]:bg-sky-100 has-[:checked]:border-sky-500 has-[:checked]:ring-2 has-[:checked]:ring-sky-200">
                                            <input type="radio" name="q${index}" value="${optIndex}" class="h-5 w-5 text-sky-600 border-slate-300 focus:ring-sky-500 focus:ring-2">
                                            <span class="ml-4 text-slate-700">${opt}</span>
                                         </label>`;
                });
                quizHtml += `</div></div>`;
            });
            quizHtml += `<button type="button" class="submit-quiz-btn w-full sm:w-auto bg-sky-600 text-white font-semibold py-3 px-8 rounded-lg shadow-md transition-all hover:bg-sky-700 active:scale-95 disabled:bg-slate-400 disabled:cursor-not-allowed" onclick="submitQuiz(${moduleId})">Validar Respuestas</button></form>`;

            displayArea.innerHTML = `
                <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl">
                    <h2 class="text-2xl sm:text-3xl font-bold text-slate-900">${moduleData.title}</h2>
                    <div class="mt-6">
                        <h3 class="text-xl font-bold text-slate-800 mb-3">Caso Clínico</h3>
                        <div class="case-study bg-amber-50 border-l-4 border-amber-500 p-5 rounded-r-lg text-amber-900 space-y-2">${moduleData.clinicalCase}</div>
                    </div>
                    <div class="mt-8">
                        <h3 class="text-xl font-bold text-slate-800">Test de Autoevaluación</h3>
                        ${quizHtml}
                    </div>
                </div>
            `;
        }

        function showCompletedModule(moduleId) {
            const moduleData = courseModules.find(m => m.id === parseInt(moduleId));
            const progressData = userProgress[moduleId];
            const displayArea = document.getElementById('module-display');
            
            const nextModuleId = parseInt(moduleId) + 1;
            const nextModule = courseModules.find(m => m.id === nextModuleId);

            let quizHtml = '<div class="quiz-form space-y-8 mt-6">';
            moduleData.quiz.forEach((q, index) => {
                const userAnswer = progressData.answers ? progressData.answers[index] : null;
                const isCorrect = userAnswer === q.answer;
                const sourceCitation = q.source;

                let feedbackHtml = `<div class="question-block bg-white p-6 rounded-xl shadow-lg border border-slate-100">
                                        <p class="font-semibold text-slate-800 mb-4 text-base sm:text-lg">${index + 1}. ${q.question}</p>
                                        <div class="space-y-3">`;
                
                q.options.forEach((opt, optIndex) => {
                    const isUserAnswer = optIndex === userAnswer;
                    const isCorrectAnswer = optIndex === q.answer;
                    
                    let labelClasses = 'flex items-center justify-between p-4 border-2 rounded-lg';
                    let icon = '';

                    if (isCorrectAnswer) {
                        labelClasses += ' bg-emerald-50 border-emerald-500';
                        if (isUserAnswer) icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-emerald-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`;
                    } else if (isUserAnswer) {
                        labelClasses += ' bg-red-50 border-red-500';
                        icon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>`;
                    } else {
                         labelClasses += ' border-slate-200 bg-slate-50 opacity-80';
                    }

                    feedbackHtml += `<div class="${labelClasses}">
                                            <span class="text-slate-700">${opt}</span>
                                            ${icon}
                                         </div>`;
                });
                
                const justificationClasses = `mt-4 p-4 rounded-lg border-l-4 ${isCorrect ? 'bg-emerald-50 border-emerald-500 text-emerald-900' : 'bg-red-50 border-red-500 text-red-900'}`;
                const justificationHtml = `<div class="${justificationClasses}">
                                                <p><strong class="font-bold">${isCorrect ? 'Correcto' : 'Incorrecto'}.</strong> ${q.justification}</p>
                                                <p class="text-sm italic mt-2 opacity-80">Fuente: ${sourceCitation}</p>
                                           </div>`;

                feedbackHtml += `</div>${justificationHtml}</div>`;
                quizHtml += feedbackHtml;
            });
            quizHtml += '</div>';

            let nextModuleButton = '';
            const allModulesCompleted = Object.values(userProgress).filter((p, i) => i < courseModules.length).every(p => p.completed);

            if (allModulesCompleted && courseModules.length === Object.keys(userProgress).filter(k => userProgress[k].completed).length) {
                 nextModuleButton = `<button class="mt-10 w-full sm:w-auto bg-emerald-600 text-white font-semibold py-3 px-8 rounded-lg shadow-md transition-all hover:bg-emerald-700 active:scale-95 text-lg" onclick="showFinalSummary()">Ver Resumen Final</button>`;
            } else if (nextModule) {
                nextModuleButton = `<button class="mt-10 w-full sm:w-auto bg-sky-600 text-white font-semibold py-3 px-8 rounded-lg shadow-md transition-all hover:bg-sky-700 active:scale-95 text-lg" onclick="displayModule(${nextModule.id})">
                    Continuar al Siguiente Módulo
                </button>`;
            } else {
                const firstUncompleted = Object.keys(userProgress).find(id => !userProgress[id].completed && courseModules.find(m => m.id == id));
                 if (firstUncompleted) {
                      nextModuleButton = `<button class="mt-10 w-full sm:w-auto bg-gray-600 text-white font-semibold py-3 px-8 rounded-lg shadow-md transition-all hover:bg-gray-700 active:scale-95 text-lg" onclick="displayModule(${firstUncompleted})">
                                    Ir al primer módulo incompleto
                               </button>`;
                 }
            }
            
            displayArea.innerHTML = `
                <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl">
                    <h2 class="text-2xl sm:text-3xl font-bold text-slate-900">${moduleData.title} (Revisión)</h2>
                        <div class="module-summary mt-6 bg-sky-50 border-l-4 border-sky-500 p-5 rounded-r-lg text-sky-900">
                               <h3 class="font-bold text-lg mb-2">Resumen del Módulo</h3>
                               <p>${moduleData.summary}</p>
                        </div>
                    <div class="mt-6">
                        <h3 class="text-xl font-bold text-slate-800 mb-3">Caso Clínico</h3>
                        <div class="case-study bg-amber-50 border-l-4 border-amber-500 p-5 rounded-r-lg text-amber-900 space-y-2">${moduleData.clinicalCase}</div>
                        ${moduleData.clinicalCaseAnswer ? `
                        <div class="mt-4 bg-green-50 border-l-4 border-green-500 p-5 rounded-r-lg text-green-900">
                            <h4 class="font-bold">Resolución de la Pregunta Clave:</h4>
                            <p class="mt-2">${moduleData.clinicalCaseAnswer}</p>
                        </div>
                        ` : ''}
                    </div>
                    <h3 class="text-xl font-bold text-slate-800 mt-8">Resultados del Test</h3>
                    ${quizHtml}
                    <div class="text-center">
                        ${nextModuleButton}
                    </div>
                </div>`;
        }


        function submitQuiz(moduleId) {
            const moduleData = courseModules.find(m => m.id === moduleId);
            const form = document.getElementById('quiz-form-' + moduleId);
            let score = 0;
            let userAnswers = {};

            moduleData.quiz.forEach((q, index) => {
                const selectedOption = form.querySelector(`input[name="q${index}"]:checked`);
                if (selectedOption) {
                    const answerIndex = parseInt(selectedOption.value);
                    userAnswers[index] = answerIndex;
                    if (answerIndex === q.answer) {
                        score++;
                    }
                } else {
                    userAnswers[index] = null;
                }
            });
            
            userProgress[moduleId].completed = true;
            userProgress[moduleId].score = score;
            userProgress[moduleId].answers = userAnswers;
            
            saveProgress();
            updateProgressBar();
            renderModuleList();
            
            showCompletedModule(moduleId);
            
            checkCourseCompletion();
        }

        function updateProgressBar() {
            if (!userProgress || Object.keys(userProgress).length === 0) return;
            const completedModules = Object.values(userProgress).filter(p => p && p.completed).length;
            const totalModules = 17; 
            const percentage = totalModules > 0 ? (completedModules / totalModules) * 100 : 0;
            
            const progressBar = document.getElementById('progress-bar');
            progressBar.style.width = percentage + '%';
            progressBar.textContent = Math.round(percentage) + '%';
        }

        function checkCourseCompletion() {
            const definedModules = courseModules.map(m => m.id);
            const allDefinedModulesCompleted = definedModules.every(id => userProgress[id] && userProgress[id].completed);
            
            if (allDefinedModulesCompleted) {
                setTimeout(showFinalSummary, 1000);
            }
        }

        function showFinalSummary() {
            let totalScore = 0;
            let totalQuestions = 0;

            let moduleScoresHtml = '<div class="space-y-4 mt-6">';
            courseModules.forEach(module => {
                if (userProgress[module.id] && userProgress[module.id].completed) {
                    const moduleScore = userProgress[module.id].score;
                    const moduleTotalQuestions = module.quiz.length;
                    totalScore += moduleScore;
                    totalQuestions += moduleTotalQuestions;
                    const percentage = moduleTotalQuestions > 0 ? (moduleScore / moduleTotalQuestions) * 100 : 0;

                    moduleScoresHtml += `
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-base font-medium text-slate-700">${module.title}</span>
                                <span class="text-sm font-medium text-slate-700">${moduleScore} / ${moduleTotalQuestions}</span>
                            </div>
                            <div class="w-full bg-slate-200 rounded-full h-2.5">
                                <div class="bg-sky-600 h-2.5 rounded-full" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    `;
                }
            });
            moduleScoresHtml += '</div>';
            
            const finalPercentage = totalQuestions > 0 ? (totalScore / totalQuestions) * 100 : 0;
            
            const displayArea = document.getElementById('module-display');
            displayArea.innerHTML = `
                <div id="final-score-screen" class="bg-white p-8 sm:p-12 rounded-2xl shadow-xl transform transition-all duration-500 scale-100 opacity-100">
                    <h2 class="text-3xl sm:text-4xl font-bold text-emerald-600">¡Curso Completado!</h2>
                    <p class="text-slate-600 mt-2">Has finalizado todos los módulos disponibles. Aquí está tu resumen de calificaciones.</p>
                    <div class="text-left mt-8">
                        <h3 class="text-xl font-bold text-slate-800">Calificación por Módulo</h3>
                        ${moduleScoresHtml}
                    </div>
                    <div class="mt-8 pt-6 border-t">
                         <p class="text-slate-700">Tu calificación final es:</p>
                        <p id="score-value" class="text-5xl sm:text-7xl font-bold text-slate-800 mt-2">${Math.round(finalPercentage)}<span class="text-3xl text-slate-500"> / 100</span></p>
                    </div>
                </div>`;
        }

        // --- Modals & API Functions ---
        function showSummaryModal() {
            const modal = document.getElementById('summary-modal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.querySelector('div').classList.remove('scale-95');
            }, 10);
        }

        function hideSummaryModal() {
            const modal = document.getElementById('summary-modal');
            modal.querySelector('div').classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function renderSummary() {
            const summaryContent = document.getElementById('summary-content');
            if (summaryContent) {
                summaryContent.innerHTML = summaryContentHtml;
            }
        }

        function showBibliographyModal() {
            const modal = document.getElementById('bibliography-modal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.querySelector('div').classList.remove('scale-95');
            }, 10);
        }

        function hideBibliographyModal() {
            const modal = document.getElementById('bibliography-modal');
            modal.querySelector('div').classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function renderBibliography() {
            const bibliographyContent = document.getElementById('bibliography-content');
            if (!bibliographyContent) return;

            const allSources = [];
            courseModules.forEach(module => {
                if (module.quiz) {
                    module.quiz.forEach(q => {
                        if (q.source && !allSources.includes(q.source)) {
                            allSources.push(q.source);
                        }
                    });
                }
            });
            allSources.sort();
            
            bibliographyContent.innerHTML = '';
            allSources.forEach(citation => {
                const item = document.createElement('div');
                item.className = 'bg-slate-100 p-3 rounded-lg flex items-start gap-3 text-sm';
                item.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-500 flex-shrink-0 mt-1" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 16c1.255 0 2.443-.29 3.5-.804V4.804zM14.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 0114.5 16c1.255 0 2.443-.29 3.5-.804v-10A7.968 7.968 0 0014.5 4z" />
                    </svg>
                    <span>${citation}</span>
                `;
                bibliographyContent.appendChild(item);
            });
        }
    </script>
</body>
</html>

